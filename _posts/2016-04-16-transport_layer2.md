---
title: 运输层（二） 可靠传输
date: 2016-04-16
categories: Network
---

本文是介绍传输层的第二篇，总结 TCP 的可靠传输，主要参考谢希仁编著的《计算机网络（第6版）》。

# 1. 可靠传输的工作原理

由于 TCP 下面的网络所提供的是不可靠的传输，因此，TCP 必须采用适当的措施才能使得两个运输层之间的通信变得可靠。

## 停止等待协议

所谓“停止等待”就是每发送完一个分组就停止发送，等待对方的确认，在收到确认后再发送下一个分组。

![](http://7xrvqe.com1.z0.glb.clouddn.com/16-4-16/26104522.jpg)

![](http://7xrvqe.com1.z0.glb.clouddn.com/16-4-16/33993695.jpg)

其中图中设计到自动重传请求 ARQ（Automatic Repeat reQuest）；

**信道利用率**

停止等待协议的优点是简单，但缺点是信道利用率太低。为了提高传输效率，发送方可以不是用低效率的停止等待协议，而是采用流水线传输。流水线传输就是发送方可连续发送多个分组，不必每发送完一个分组就停顿下来等待对方的确认。

![](http://7xrvqe.com1.z0.glb.clouddn.com/16-4-16/32800060.jpg)

![](http://7xrvqe.com1.z0.glb.clouddn.com/16-4-16/34092170.jpg)

当使用流水线传输时，就要使用连续 ARQ 协议和滑动窗口协议。

连续 ARQ 协议规定，发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置。接收方一般都是采用累计确认的方式，也就是说，接受方不必对收到的分组逐个发送确认，而是在收到几个分组后，对按序到达的最后一个分组发送确认，这就表示：到这个分组为止的分组都已正确收到了。

回退N步：比如，如果发送方发送了前5个分组，而中间的第3个分组丢失，这时接收方只能对前两个分组发出确认，发送方无法知道后面三个分组的下落，而只好把后面的三个分组都再重传一次。

# 2. TCP 报文段的首部格式

TCP 报文段首部的前20个字节是固定的，后面有 4n 字节是根据需要而增加的选项，因此 TCP 首部的最小长度是20字节。

![](http://7xrvqe.com1.z0.glb.clouddn.com/16-4-16/25582356.jpg)

对其中部分字段进行解释：

1. **数据偏移。**占4位，它指出 TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远。由于4位二进制数能够表示的最大十进制数字是15，且其单位是4字节，因此数据偏移的最大值是60字节。
2. **紧急 URG。**当 URG=1 时，表明紧急指针字段有效，它告诉系统此报文段有紧急数据，应尽快传送，而不要按原来的排队顺序来传送。
3. **复位 RST。**当 RST=1 时，表明 TCP 连接中出现严重差错，必须释放链接，然后再重新建立运输链接。RST 置1还用来拒绝一个非法报文段或拒绝打开一个链接，RST 也可以成为重建位或重置位。
4. **窗口。**占2字节。窗口字段明确指出了现在允许对方发送的数据量。窗口值是经常动态变化的。
5. **紧急指针。**占2字节。紧急指针仅在 URG=1 时才有意义，它指出本报文段中的紧急数据的字节数。
6. **选项。**其中有一种选项，最大报文段长度 MSS（Maximum Segment Size），MSS 是每个 TCP 报文段中的数据字段的最大长度。

# 3. TCP 可靠传输的实现

下面将通过滑动窗口、超时重传、选择确认 SACK来解释 TCP 可靠传输的实现。

## 以字节为单位的滑动窗口

![](http://7xrvqe.com1.z0.glb.clouddn.com/16-4-16/29074344.jpg)

从上图可以看出，要描述一个发送窗口的状态需要三个指针：P1,P2,P3。指针都指向字节的序号，这三个指针指向的几个部分的意义如下：

- 小于 P1 的是已发送并已收到确认的字节数
- P3-P1=A 的发送窗口（通知窗口）
- P2-P1= 允许发送但尚未收到确认的字节数
- P3-P2= 允许发送但尚未发送的自己数（又称可用窗口或有效窗口）

