---
title: 传输层（三）：流量控制
date: 2016-05-17
categories: 基础知识
---

流量控制主要是通过滑动窗口来进行控制的。

在流量控制中需要注意三个问题：

## 问题一

假设有两个应用进程 A 和 B，B 向 A 发送了零窗口的报文段后不久，B 的接收缓存又有了一些空间，于是 B 向 A 发送了 rwnd=400 的报文段，然而这个报文段在传送过程中丢失了，而 A 一直等待收到 B 发送的非零窗口的通知，而 B 也在一直等待 A 发送的数据。如果没有其他措施，这种互相等待的死锁局面将一直延续下去。

**解决方案：**TCP 为每一个连接设有一个持续计时器，只要 TCP 连接的一方收到对方的零窗口通知，就启动持续计时器，若持续计时器设置的时间到期，就发送一个零窗口探测报文段（仅携带 1 字节的数据），而对方就在确认这个探测报文报文段时给出现在的窗口值。如果窗口仍然是零，那么收到这个报文段的一方就重新设置持续计时器。如果窗口不是零，那么死锁的僵局就能被打破。

## 问题二

关于发送，如果每次发送都是只发送一个数据，那么显然效率不高。

**解决方案：**Nagle 算法。主要概括为两点：任意时刻，最多只能有一个未被确认的小段；当到达的数据已到达发送窗口大小的一半或已到达报文段的最大长度时，就立即发送一个报文段，此时可能不符合第一点。

## 问题三

糊涂窗口综合征：TCP 接收方的缓存已满，而交互式的应用程序一次只ｃｏ９ｎｇ接收缓存中读取一个字节（这样就使接收缓存仅腾出 1 个字节），然后向发送方发送确认，并把窗口设置为 1 个字节，这样就一个一个的接收，网络效率很低。

**解决方案：**可以让接受方等待一段时间，使得接收缓存已有足够空间容纳一个最长的报文段，或者等到接收方缓存已有一半空闲的空间。也可以让发送方不要发送太小的报文段，而是把数据积累成足够大的报文段，或达到接收方缓存空间的一半大小。
