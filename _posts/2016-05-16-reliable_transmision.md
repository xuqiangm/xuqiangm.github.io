---
title: 传输层（二） 可靠传输
date: 2016-05-16
categories: 基础知识
---

# 可靠传输的工作原理

由于 TCP 下面的网络所提供的是不可靠的传输。因此，TCP 必须采用适当的措施才能使得两个运输层之间的通信变得可靠。

理想的传输条件有一下两个特点：

- 传输信道不产生差错
- 不管发送方以多快的速度发送数据，接收方总是来得及处理收到的数据

然而在实际网络都不具备以上两个理想条件，但是可以通过使用一些可靠传输协议来实现可靠传输。当出现差错时，让发送方重传出错的数据，同时在接收方来不及处理收到的数据时，及时告诉发送方适当降低发送数据的速度。

可靠传输的协议中，最简单的是停止等待协议。这个协议中最重要的一个机制是在出错时的超时重传机制。

由于停止等待协议对信道的利用率很低，因而引入了连续 ARQ 协议，其中需要的用到滑动窗口协议。在连续 ARQ 协议中，采取的是累积确认的方式，而不是像停止等待协议中，一个一个的确认。然而，由于采取了累积确认的方式，如果中间某一个分组出现错误，那么需要把该分组后面的分组重传，各个叫做回退 N 步。

# TCP 可靠传输的实现

在这一部分，主要介绍的是滑动窗口、选择重传时间的选择、选择确认 SACK。

**以字节为单位的滑动窗口**

关于滑动窗口已经是比较熟悉了，这里需要注意的是缓冲与窗口之间的关系。

![](http://7xrvqe.com1.z0.glb.clouddn.com/16-5-17/85580515-20150801071241007)

发送窗口用来暂时存放：

1. 发送应用程序传送给发送方 TCP 准备发送的数据
2. TCP 已发送出但尚未收到确认的数据

![](http://7xrvqe.com1.z0.glb.clouddn.com/16-5-17/30980195-20150801071241007)

接受缓存用来暂时存放：

1. 按序到达的、但尚未被接收应用程序读取的数据
1. 未按序到达的数据

**超时重传时间的选择**

超时重传时间 RTO = RTTs + 4*RTTd

其中 RTT 为报文往返时间，RTTs 为每当第一次测量到 RTT 样本时 RTT 的值。RTTd 是 RTT 的偏差的加权平均值。

对于 RTT 的测量，有一种情况需要考虑：发送出一个报文段，设定的重传时间到了，还没有收到确认，于是重传报文段，经过一段时间后，收到确认报文段，现在的问题是，如何判定此确认报文段是对先发送的报文段的确认，还是对后重传的报文段的确认。

改进的 Karn 算法，可以解决这个问题：报文段每重传一次，就把超时重传时间 RTO 增大一些。典型的算法是取新的重传时间的 2 倍。当不再发生报文段的重传时，才根据上面的式子计算超时重传时间。

**选择确认 SACK**

使用选择确认可以避免对已经正确到达数据的重传（改进回退 N 步）。

